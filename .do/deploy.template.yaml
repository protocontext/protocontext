spec:
  name: protocontext
  region: nyc

  services:
    - name: api
      dockerfile_path: engine/Dockerfile
      source_dir: /engine
      github:
        repo: protocontext/protocontext
        branch: main
        deploy_on_push: true
      http_port: 8000
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      routes:
        - path: /api
          preserve_path_prefix: true
      envs:
        - key: TYPESENSE_URL
          value: "http://typesense:8108"
          scope: RUN_TIME
          type: GENERAL
        - key: TYPESENSE_API_KEY
          value: "${typesense.TYPESENSE_API_KEY}"
          scope: RUN_TIME
          type: SECRET

    - name: dashboard
      dockerfile_path: web/Dockerfile
      source_dir: /web
      github:
        repo: protocontext/protocontext
        branch: main
        deploy_on_push: true
      http_port: 3000
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      build_command: ""
      routes:
        - path: /
      envs:
        - key: NEXT_PUBLIC_API_URL
          value: "${api.PUBLIC_URL}"
          scope: BUILD_TIME
          type: GENERAL

  workers:
    - name: typesense
      dockerfile_path: .do/typesense.Dockerfile
      github:
        repo: protocontext/protocontext
        branch: main
        deploy_on_push: true
      instance_count: 1
      instance_size_slug: apps-s-1vcpu-0.5gb
      envs:
        - key: TYPESENSE_API_KEY
          scope: RUN_TIME
          type: SECRET
          value: "changeme-on-deploy"
        - key: TYPESENSE_DATA_DIR
          value: "/data"
          scope: RUN_TIME
          type: GENERAL
